---
layout: post
title:  初识主流的几种注册中心(Nacos,Zookeeper,Eureka等)
category: [nacos]
tags: [nacos]
modified: 2021-03-29
---


# 3.29-从了解注册中心出发，认识一下新朋友—nacos

## 注册中心的本职工作

微服务的分布式属性决定了服务提供者和消费者的数量是动态变化的，于是进一步便产生了弹性扩所容特性的需求，于是便需要引入服务提供者的注册与发现，这件事由Registry来做。

## Registry解决方案

1. 应用内， Eureka就是一种，当然也可以基于zookeeper自己实现。

2. 应用外：将应用当作一个黑盒，是一种目标为减少侵入性的实现方式。

3. DNS
   1. dns存在固有的缓存缺陷。

## 从开发和运维的角度考虑五个方面：

测活：服务注册之后，如何对服务进行测活以保证服务的可用性？

负载均衡：当存在多个服务提供者时，如何均衡各个提供者的负载？

集成：在服务提供端或者调用端，如何集成注册中心？

运行时依赖：引入注册中心之后，对应用的运行时环境有何影响？

可用性：如何保证注册中心本身的可用性，特别是消除单点故障？



## 主流Registry的对比

主流注册中心产品

软件产品特性并非一成不变，如果发现功能特性有变更，欢迎评论指正

|                  | Nacos                      | Eureka      | Consul            | CoreDNS    | Zookeeper  |
| ---------------- | -------------------------- | ----------- | ----------------- | ---------- | ---------- |
| 一致性协议       | CP+AP                      | AP          | CP                | --         | CP         |
| 健康检查         | TCP/HTTP/MYSQL/Client Beat | Client Beat | TCP/HTTP/gRPC/Cmd | --         | Keep Alive |
| 负载均衡策略     | 权重/metadata/Selector     | Ribbon      | Fabio             | RoundRobin | --         |
| 雪崩保护         | 有                         | 优          | 无                | 无         | 无         |
| 自动注销         | 支持                       | 支持        |                   |            | 支持       |
| 访问协议         | HTTP/DNS                   | HTTP        |                   |            | TCP        |
| 监听支持         | 支持                       | 支持        |                   |            | 支持       |
| 多数据中心       | 支持                       | 支持        |                   |            | 不支持     |
| 跨注册中心同步   | 支持                       | 不支持      |                   |            | 不支持     |
| Spring Cloud集成 | 支持                       | 支持        |                   |            | 支持       |
| Dubbo集成        | 支持                       | 不支持      |                   |            | 支持       |
| K8S              | 支持                       | 不支持      |                   |            | 不支持     |





Why Nacos？

- 啥都有

- eureka不支持：

  - 不支持跨注册中心同步
  - 不支持Dubbo集成
  - 不支持K8S集成

- 为啥不zookeeper：

  - 不支持多数据中心
  - 不支持跨注册中心同步
  - 不支持k8s

  

## 细看 Zookeeper（CP）

### 核心

zookeeper的设计紧遵CP原则，目标是数据的一直性，所以在leader宕机时会进行election。（动物园和cp的关系？）

### 结合场景看待为什么ZK选择CP原则

在大部分分布式环境中，尤其涉及数据存储的场景时，数据一致性应该是首先被保证的，这也是Zookeeper涉及谨遵CP的另一个原因。
但是对于服务发现来说，针对同一个服务，注册中心的不同节点保存的服务提供者信息存在差异，不会导致灾难。

<u>值得注意的一点，leader的选举通常需要30-120s，其间集群都不可用。</u>



## 那么Eureka是怎么解决这个问题的呢？

Eureka是**闭源**的！

Eureka首先也可以运行多个实例来构建集群的。区别于zookeeper的选举机制，eureka采用的是Peer to Peer对等通信，这是一种去中心化的架构，不区分Master/Slave。当某台eureka server（承担registry的角色）宕机的时候，client的请求会自动切换到新的server节点。

### Replicate to Peer操作 （实现同步的方式）

当节点接受client的请求时，所有的操作都会在节点间复制（replicate to peer），将请求复制到该server目前已知的所有其他server中。

### 启动新节点

当新的节点启动，会先获取邻近节点的注册信息，完成初始化。具体是通过getEurekaServicesUrls（），并且通过**<u>心跳契约</u>**来定期更新。

- 心跳的默认周期是30s，若超时90s则会自动注销该服务的实例
- 若server在短时间内丢失过多节点，会进入“**自我保护**”
  1. **停止移除心跳过期服务**
  2. 继续请求，但**停止同步**

### Nacos：

Nacos是阿里开源的，Nacos 支持基于 DNS 和基于 RPC 的服务发现。在Spring Cloud中使用Nacos，只需要先下载 Nacos 并启动 Nacos server，Nacos只需要简单的配置就可以完成服务的注册发现。

Nacos除了服务的注册发现之外，还支持动态配置服务。动态配置服务可以让您以中心化、外部化和动态化的方式管理所有环境的应用配置和服务配置。动态配置消除了配置变更时重新部署应用和服务的需要，让配置管理变得更加高效和敏捷。配置中心化管理让实现无状态服务变得更简单，让服务按需弹性扩展变得更容易。

一句话概括就是Nacos = Spring Cloud注册中心 + Spring Cloud配置中心。